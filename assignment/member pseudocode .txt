DECLARE user_id AS LIST
DECLARE password AS LIST
DECLARE borrowed_books AS LIST

IMPORT datetime, timedelta FROM datetime module


FUNCTION read_users_from_file():
    CREATE empty list users
    OPEN "account.txt" FOR reading
    FOR each line IN file:
        SPLIT line by "," INTO parts
        IF parts has 3 elements THEN
            SET username = parts[0]
            SET pwd = parts[1]
            SET role = parts[2]
            APPEND {"user_id": username, "password": pwd, "role": role} TO users
    END FOR
    RETURN users
END FUNCTION


FUNCTION loginpage():
    SET users = read_users_from_file()

    DISPLAY "Please Input User ID: "
    INPUT USER_ID_TEMP
    DISPLAY "Please Input Password: "
    INPUT PASSWORD_TEMP

    SET login_success = FALSE
    SET current_user = NULL
    SET user_role = NULL

    FOR i FROM 0 TO LENGTH(users) - 1:
        IF USER_ID_TEMP == users[i]["user_id"] AND PASSWORD_TEMP == users[i]["password"] THEN
            SET login_success = TRUE
            SET current_user = users[i]["user_id"]
            SET user_role = users[i]["role"]
            BREAK
        END IF
    END FOR

    IF login_success == TRUE THEN
        IF user_role == "member" THEN
            DISPLAY "Login Successful!"
            CALL member_interface(current_user)
        ELSE
            DISPLAY "Access Denied. Only members can log in."
            CALL loginpage()
        END IF
    ELSE
        DISPLAY "ERROR: Invalid ID or Password."
        CALL loginpage()
    END IF
END FUNCTION


FUNCTION member_interface(current_user):
    DISPLAY "Member (" + current_user + ")"
    DISPLAY "-----------------------------------"
    DISPLAY "1. Search by Book Name"
    DISPLAY "2. Search by Book ID"
    DISPLAY "3. View Borrowed History"
    DISPLAY "4. Log Out"
    DISPLAY "-----------------------------------"
    DISPLAY "Please Input Choice: "
    INPUT xuan

    IF xuan == 4 THEN
        DISPLAY "Goodbye!"
    ELSE IF xuan IN [1, 2, 3] THEN
        CALL member_interface_xuan(xuan, current_user)
    ELSE
        DISPLAY "Invalid choice, please try again."
        CALL member_interface(current_user)
    END IF
END FUNCTION


FUNCTION member_interface_xuan(xuan, current_user):
    IF xuan == 1 THEN
        CALL searchbookname(current_user)
    ELSE IF xuan == 2 THEN
        CALL searchbookid(current_user)
    ELSE IF xuan == 3 THEN
        CALL borrowhistory(current_user)
    END IF
END FUNCTION


FUNCTION read_books_from_file():
    CREATE empty list books
    OPEN "book.txt" FOR reading
    FOR each line IN file:
        SPLIT line by "," INTO parts
        IF parts has 5 elements THEN
            CREATE book record with keys:
                book_id, book_name, language, number_of_book_available, author
            CONVERT available TO integer
            APPEND book record TO books
    END FOR
    RETURN books
END FUNCTION


FUNCTION write_books_to_file(books):
    OPEN "book.txt" FOR writing
    FOR each book IN books:
        WRITE all book data in a single line separated by commas
    END FOR
END FUNCTION


FUNCTION save_borrow_record(member_name, book_name, book_id, due_date):
    OPEN "borrowed_books.txt" FOR appending
    WRITE member_name, book_name, book_id, "Due:", due_date TO file
END FUNCTION


FUNCTION searchbookname(current_user):
    DISPLAY "Please enter book name:"
    INPUT bookname
    SET books = read_books_from_file()
    SET found = FALSE

    FOR each book b IN books:
        IF LOWER(bookname) == LOWER(b["book_name"]) THEN
            SET found = TRUE
            IF b["number_of_book_available"] > 0 THEN
                DISPLAY "Book found: " + b["book_name"] + " by " + b["author"]
                DISPLAY "-----------------------------------"
                DISPLAY "1. Borrow"
                DISPLAY "2. Exit"
                DISPLAY "Enter your choice:"
                INPUT CHOICE
                IF CHOICE == 1 THEN
                    DECREASE b["number_of_book_available"] BY 1
                    CALL write_books_to_file(books)

                    SET borrow_date = current date and time
                    SET due_date = borrow_date + 7 days

                    ADD {book_name, book_id, borrow_date, due_date} TO borrowed_books
                    CALL save_borrow_record(current_user, b["book_name"], b["book_id"], due_date)

                    DISPLAY "You borrowed " + b["book_name"] + ". Due date: " + due_date
                ELSE
                    DISPLAY "Returning to member page..."
                    CALL member_interface(current_user)
                END IF
            ELSE
                DISPLAY "Book is not available right now."
            END IF
            BREAK
        END IF
    END FOR

    IF found == FALSE THEN
        DISPLAY "Book not found."
    END IF
    CALL member_interface(current_user)
END FUNCTION


FUNCTION searchbookid(current_user):
    DISPLAY "Please enter book ID:"
    INPUT bookid
    SET books = read_books_from_file()
    SET found = FALSE

    FOR each book b IN books:
        IF LOWER(bookid) == LOWER(b["book_id"]) THEN
            SET found = TRUE
            IF b["number_of_book_available"] > 0 THEN
                DISPLAY "Book found: " + b["book_name"] + " by " + b["author"]
                DISPLAY "-----------------------------------"
                DISPLAY "1. Borrow"
                DISPLAY "2. Exit"
                INPUT CHOICE
                IF CHOICE == 1 THEN
                    DECREASE b["number_of_book_available"] BY 1
                    CALL write_books_to_file(books)

                    SET borrow_date = current date and time
                    SET due_date = borrow_date + 3 days

                    ADD {book_name, book_id, borrow_date, due_date} TO borrowed_books
                    CALL save_borrow_record(current_user, b["book_name"], b["book_id"], due_date)

                    DISPLAY "You borrowed " + b["book_name"] + ". Due date: " + due_date
                ELSE
                    DISPLAY "Returning to member page..."
                    CALL member_interface(current_user)
                END IF
            ELSE
                DISPLAY "Book is not available right now."
            END IF
            BREAK
        END IF
    END FOR

    IF found == FALSE THEN
        DISPLAY "Book not found."
    END IF
    CALL member_interface(current_user)
END FUNCTION


FUNCTION borrowhistory(current_user):
    IF LENGTH(borrowed_books) == 0 THEN
        DISPLAY "You have not borrowed any books yet."
    ELSE
        DISPLAY "Borrowed Books:"
        FOR each b IN borrowed_books:
            DISPLAY "- " + b["book_name"] + " (ID: " + b["book_id"] + ")"
            DISPLAY "  requested on: " + b["borrow_date"]
            DISPLAY "  expired date: " + b["due_date"]
        END FOR
    END IF
    CALL member_interface(current_user)
END FUNCTION


# MAIN PROGRAM START
CALL loginpage()
